<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Formulario de Usuario</title>
    
    <!-- Estilos específicos de esta página -->
    <th:block layout:fragment="extra-css">
        <style>
            /* Ajuste para el contenedor principal */
            main {
                background: linear-gradient(to right, #f0f4ff, #e6edff);
                padding: 40px 20px;
            }

            .form-container {
                background: #fff;
                border-radius: 20px;
                box-shadow: 0 6px 20px rgba(0,0,0,0.1);
                padding: 50px 40px 40px;
                width: 100%;
                max-width: 900px;
                margin: 0 auto;
                position: relative;
            }

            .form-header {
                position: absolute;
                top: -30px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #0d6efd, #4b8bff);
                color: white;
                border-radius: 50%;
                width: 70px;
                height: 70px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 30px;
                box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4);
            }

            h3 {
                text-align: center;
                font-weight: 600;
                color: #0d6efd;
                margin-bottom: 10px;
                margin-top: 20px;
            }

            .form-subtitle {
                text-align: center;
                color: #6c757d;
                font-size: 0.9rem;
                margin-bottom: 30px;
            }

            .section-title {
                color: #0d6efd;
                font-weight: 600;
                font-size: 1.1rem;
                margin-top: 25px;
                margin-bottom: 15px;
                padding-bottom: 8px;
                border-bottom: 2px solid #e9ecef;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            label {
                font-weight: 500;
                color: #495057;
                margin-bottom: 8px;
            }

            .form-control, .form-select {
                border-radius: 8px;
                border: 1.5px solid #dee2e6;
                padding: 10px 15px;
            }

            .form-control:focus, .form-select:focus {
                border-color: #0d6efd;
                box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
            }

            .btn-primary {
                background: linear-gradient(90deg, #0d6efd, #4b8bff);
                border: none;
                padding: 12px 40px;
                border-radius: 10px;
                font-weight: 500;
                transition: all 0.3s;
            }

            .btn-primary:hover {
                background: linear-gradient(90deg, #0062e6, #0053b3);
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(13, 110, 253, 0.3);
            }

            .btn-secondary {
                border-radius: 10px;
                padding: 12px 40px;
                font-weight: 500;
            }

            .form-check-input:checked {
                background-color: #0d6efd;
                border-color: #0d6efd;
            }

            .required-field::after {
                content: " *";
                color: #dc3545;
            }

            .correct {
                border-color: greenyellow !important;
            }

            .error {
                border-color: red !important;
            }
        </style>
    </th:block>
</head>

<body>
    <!-- IMPORTANTE: Contenido dentro del fragment -->
    <div layout:fragment="content">
        <div class="form-container">
            <div class="form-header">
                <i class="bi bi-person-plus-fill"></i>
            </div>

            <h3>Registro de Usuario</h3>
            <p class="form-subtitle">Complete todos los campos para registrar un nuevo usuario</p>

            <form th:object="${Usuario}" th:action="@{add}" method="post" enctype="multipart/form-data">

                <div class="section-title">
                    <i class="bi bi-person-circle"></i>
                    Información Personal
                </div>

                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="nombre" class="form-label required-field">Nombre</label>
                        <input type="text" class="form-control" id="nombre" th:field="*{nombre}" placeholder="Ej: Alexis">      
                        <span th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}" class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <label for="apellidoPaterno" class="form-label required-field">Apellido Paterno</label>
                        <input type="text" class="form-control" id="apellidoPaterno" th:field="*{apellidoPaterno}" placeholder="Ej: Gamboa"> 
                        <span th:if="${#fields.hasErrors('apellidoPaterno')}" th:errors="*{apellidoPaterno}" class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <label for="apellidoMaterno" class="form-label required-field">Apellido Materno</label>
                        <input type="text" class="form-control" id="apellidoMaterno" th:field="*{apellidoMaterno}" placeholder="Ej: Gamboa">  
                        <span th:if="${#fields.hasErrors('apellidoMaterno')}" th:errors="*{apellidoMaterno}" class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <label for="username" class="form-label required-field">UserName</label>
                        <input type="text" class="form-control" id="username" th:field="*{userName}" placeholder="Ej: Dui123"> 
                        <span th:if="${#fields.hasErrors('userName')}" th:errors="*{userName}" class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <label for="foto" class="form-label required-field">Inserta tu Foto</label>
                        <input type="file" class="form-control" name="foto" id="foto" accept="image/jpeg,image/png,image/jpg"> 
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label for="curp" class="form-label required-field">CURP</label>
                        <input type="text" class="form-control" id="curp" th:field="*{CURP}" placeholder="18 caracteres" maxlength="18"> 
                        <span th:if="${#fields.hasErrors('CURP')}" th:errors="*{CURP}" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label for="fechaNacimiento" class="form-label required-field">Fecha de Nacimiento</label>
                        <input type="date" class="form-control" id="fechaNacimiento" 
                               th:field="*{fechaNacimiento}" onchange="ValidarFecha(this)">  
                        <span class="error-msg-fecha text-danger"></span>
                        <span th:if="${#fields.hasErrors('fechaNacimiento')}" 
                              th:errors="*{fechaNacimiento}" class="text-danger"></span>
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label class="form-label required-field">Sexo</label>
                        <div class="d-flex gap-4 mt-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" th:field="*{sexo}" id="masculino" value="M" required>                      
                                <label class="form-check-label" for="masculino">
                                    <i class="bi bi-gender-male text-primary"></i> Masculino
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" th:field="*{sexo}" id="femenino" value="F" required>
                                <label class="form-check-label" for="femenino">
                                    <i class="bi bi-gender-female text-danger"></i> Femenino
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-title">
                    <i class="bi bi-envelope-fill"></i>
                    Datos de Contacto
                </div>

                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="email" class="form-label required-field">Email</label>
                        <input type="email" class="form-control" id="email" th:field="*{email}" placeholder="usuario@ejemplo.com">
                        <span th:if="${#fields.hasErrors('Email')}" th:errors="*{email}" class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <label for="telefono" class="form-label">Teléfono</label>
                        <input type="tel" class="form-control" id="telefono" th:field="*{telefono}" placeholder="5512345678" maxlength="17">
                        <span th:if="${#fields.hasErrors('telefono')}" th:errors="*{telefono}" class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <label for="celular" class="form-label">Celular</label>
                        <input type="tel" class="form-control" id="celular" th:field="*{celular}" placeholder="5559876543" maxlength="17">
                        <span th:if="${#fields.hasErrors('Celular')}" th:errors="*{celular}" class="text-danger"></span>
                    </div>
                </div>

                <div class="section-title">
                    <i class="bi bi-shield-lock-fill"></i>
                    Datos de Cuenta
                </div>

                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="password" class="form-label required-field">Contraseña</label>
                        <input type="password" class="form-control" id="password" th:field="*{password}" placeholder="********">
                        <span th:if="${#fields.hasErrors('Password')}" th:errors='*{password}' class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <label for="nombreRol" class="form-label required-field">Rol</label>
                        <select class="form-select" id="nombreRol" th:field="*{rol.idRol}">
                            <option value="0" selected>Selecciona un rol</option>
                            <option th:each="rol : ${roles}" th:value="${rol.idRol}" th:text="${rol.nombreRol}"></option>
                        </select>
                    </div>
                </div>

                <div class="section-title">
                    <i class="bi bi-geo-alt-fill"></i>
                    Dirección
                </div>
                
                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <label for="calle" class="form-label required-field">Calle</label>
                        <input type="text" class="form-control" id="calle" th:field="*{direcciones[0].calle}" placeholder="Ej: Av. Insurgentes">
                    </div>      
                    <div class="col-md-4">
                        <label for="ddlpais" class="form-label required-field">País</label>
                        <select class="form-select" id="ddlpais">
                            <option value="0" selected>Selecciona tu País</option>
                            <option value="1">México</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="ddlestado" class="form-label required-field">Estado</label>
                        <select class="form-select" id="ddlestado">
                            <option value="0" selected>Selecciona tu Estado</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="ddlmunicipio" class="form-label required-field">Municipio</label>
                        <select class="form-select" id="ddlmunicipio">
                            <option value="0" selected>Selecciona tu Municipio</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="ddlcolonia" class="form-label required-field">Colonia</label>
                        <select class="form-select" id="ddlcolonia" th:field="*{direcciones[0].colonia.idColonia}">
                            <option value="0" selected>Selecciona tu Colonia</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="codigoPostal" class="form-label">Código Postal</label>
                        <input type="text" class="form-control" id="codigoPostal" placeholder="Se llenará automáticamente" readonly>
                    </div>
                </div> 
                
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label for="numeroExterior" class="form-label required-field">Número Exterior</label>
                        <input type="text" class="form-control" id="numeroExterior" th:field="*{direcciones[0].numeroExterior}" placeholder="Ej: 123">
                    </div>
                    <div class="col-md-6">
                        <label for="numeroInterior" class="form-label">Número Interior</label>
                        <input type="text" class="form-control" id="numeroInterior" th:field="*{direcciones[0].numeroInterior}" placeholder="Ej: 4B">
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="confirmar">
                            <label class="form-check-label" for="confirmar">
                                Confirmo que todos los datos proporcionados son correctos
                            </label>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12 text-center d-flex gap-3 justify-content-center">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Registrar Usuario
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="window.location.href = '/usuario'">
                            <i class="bi bi-x-circle me-2"></i>Cancelar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Scripts específicos de esta página -->
    <th:block layout:fragment="extra-scripts">
        <script>
            $(document).ready(function () {
                console.log("Scripts cargados correctamente");

                // Cargar estados al seleccionar país
                $("#ddlpais").change(function () {
                    $.ajax({
                        type: 'GET',
                        url: "/usuario/estado/" + $("#ddlpais").val(),
                        datatype: "json",
                        success: function (data) {
                            $("#ddlestado").empty();
                            $("#ddlestado").append("<option value=0 selected>Selecciona un estado</option>");
                            $.each(data.objects, function (i, estado) {
                                $("#ddlestado").append("<option value=" + estado.idEstado + ">" + estado.nombre + "</option>");
                            });
                        },
                        error: function () {
                            alert("No se pudieron cargar los estados");
                        }
                    });
                });

                // Cargar municipios al seleccionar estado
                $("#ddlestado").change(function () {
                    $.ajax({
                        type: 'GET',
                        url: "/usuario/municipio/" + $("#ddlestado").val(),
                        datatype: "json",
                        success: function (data) {
                            $("#ddlmunicipio").empty();
                            $("#ddlmunicipio").append("<option value=0 selected>Selecciona un municipio</option>");
                            $.each(data.objects, function (i, municipio) {
                                $("#ddlmunicipio").append("<option value=" + municipio.idMunicipio + ">" + municipio.nombre + "</option>");
                            });
                        },
                        error: function () {
                            alert("No se pudieron cargar los municipios");
                        }
                    });
                });

                // Cargar colonias al seleccionar municipio
                $("#ddlmunicipio").change(function () {
                    $.ajax({
                        type: 'GET',
                        url: "/usuario/colonia/" + $("#ddlmunicipio").val(),
                        datatype: "json",
                        success: function (data) {
                            $("#ddlcolonia").empty();
                            $("#ddlcolonia").append("<option value=0 selected>Selecciona una Colonia</option>");
                            $.each(data.objects, function (i, colonia) {
                                $("#ddlcolonia").append("<option value=" + colonia.idColonia + ">" + colonia.nombre + "</option>");
                            });
                        },
                        error: function () {
                            alert("No se pudieron cargar las colonias");
                        }
                    });
                });

                // Cargar código postal al seleccionar colonia
                $("#ddlcolonia").on('blur change', function () {
                    var idColonia = $(this).val();

                    if (idColonia == "0" || !idColonia) {
                        $("#codigoPostal").val("");
                        return;
                    }

                    $.ajax({
                        type: 'GET',
                        url: "/usuario/codigopostal/" + idColonia,
                        datatype: "json",
                        success: function (data) {
                            if (data.correct && data.object && data.object.codigoPostal) {
                                $("#codigoPostal").val(data.object.codigoPostal);
                            } else {
                                $("#codigoPostal").val("");
                            }
                        },
                        error: function () {
                            alert("No se pudo cargar el código postal");
                        }
                    });
                });

                // Validación de fecha
                let hoy = new Date().toISOString().split('T')[0];
                $("#fechaNacimiento").attr('max', hoy);
            });

            function ValidarFecha(input) {
                let fechaSeleccionada = new Date($(input).val());
                let fechaActual = new Date();

                fechaActual.setHours(0, 0, 0, 0);
                fechaSeleccionada.setHours(0, 0, 0, 0);

                if ($(input).val() === "") {
                    $(input).removeClass("error").removeClass("correct");
                    $(input).siblings(".error-msg-fecha").text("");
                } else if (fechaSeleccionada > fechaActual) {
                    $(input).removeClass("correct").addClass("error");
                    $(input).siblings(".error-msg-fecha").text("La fecha no puede ser mayor a la fecha actual");
                } else {
                    $(input).removeClass("error").addClass("correct");
                    $(input).siblings(".error-msg-fecha").text("");
                }
            }
        </script>
    </th:block>
</body>
</html>